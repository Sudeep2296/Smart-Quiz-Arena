{% extends 'base.html' %}
{% load static %}

{% block title %}Code Editor - SmartQuiz Arena{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Code Battle Editor</h4>
                    <p>Battle Code: <strong>{{ battle.battle_code }}</strong> | Status: {{ battle.status }}</p>
                </div>
                <div class="card-body">
                    {% if current_challenge %}
                    <h5>Current Challenge: {{ current_challenge.title }}</h5>
                    <p><strong>Description:</strong> {{ current_challenge.description }}</p>
                    <p><strong>Problem Statement:</strong> {{ current_challenge.problem_statement }}</p>
                    <p><strong>Sample Input/Output:</strong> {{ current_challenge.sample_io }}</p>
                    <p><strong>Difficulty:</strong> {{ current_challenge.difficulty }} | <strong>Time Limit:</strong> {{
                        current_challenge.time_limit }}s</p>

                    <div class="mb-3">
                        <label for="code-input" class="form-label">Your Code:</label>
                        <textarea class="form-control" id="code-input" rows="15"
                            placeholder="Write your code here..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="language-select" class="form-label">Language:</label>
                        <select class="form-select" id="language-select">
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="stdin-input" class="form-label">Standard Input (optional):</label>
                            <textarea class="form-control" id="stdin-input" rows="5"
                                placeholder="Enter input for your program..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Terminal Output:</label>
                            <div id="terminal-output" class="border rounded p-3 bg-dark text-light"
                                style="min-height: 150px; font-family: 'Courier New', monospace; font-size: 14px;">
                                <div class="text-muted">Output will appear here...</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button id="run-code" class="btn btn-info me-2">Run Code</button>
                        <button id="submit-code" class="btn btn-success">Submit Code</button>
                    </div>
                    <div id="run-result" class="mb-3"></div>
                    <div id="submission-result" class="mt-3"></div>
                    {% else %}
                    <p>No current challenge available. Battle may not have started or challenges not loaded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Battle Info</h5>
                </div>
                <div class="card-body">
                    <p><strong>Host:</strong> {{ battle.player1.username }} {% if is_host %}(You){% endif %}</p>
                    {% if battle.player2 %}
                    <p><strong>Opponent:</strong> {{ battle.player2.username }}</p>
                    {% else %}
                    <p><strong>Opponent:</strong> Waiting...</p>
                    {% endif %}
                    <p><strong>Questions:</strong> {{ battle.num_questions }}</p>
                    <p><strong>Level:</strong> {{ battle.level|title }}</p>
                    <p><strong>Current Challenge:</strong> {{ battle.current_challenge_index|add:1 }} / {{
                        battle.num_questions }}</p>
                    <div id="opponent-status">Opponent Status: Waiting...</div>
                </div>
            </div>
        </div>
    </div>
    <div id="notifications" class="mt-3"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const battleCode = "{{ battle.battle_code }}";
    const userId = {{ user.id }};
    const isHost = {{ is_host|yesno:"true,false" }};
    let socket;

    function connectWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(
            wsProtocol + '//' + window.location.host + '/ws/codebattle/' + battleCode + '/'
        );

        socket.onopen = function (e) {
            console.log('WebSocket connected in editor');
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log('Editor message received:', data);

            if (data.type === 'battle_update') {
                // Update battle status, current challenge, etc.
                document.querySelector('.card-header p').innerHTML = `Battle Code: <strong>${battleCode}</strong> | Status: ${data.battle.status}`;
                if (data.battle.current_challenge_index !== undefined) {
                    document.querySelector('[data-current-index]').textContent = data.battle.current_challenge_index + 1;
                }
                updateOpponentStatus(data.battle);
            } else if (data.type === 'submission_result') {
                // Handle own submission results
                addNotification(`Your submission: ${data.result}`);
                document.getElementById('submit-code').disabled = false;
                document.getElementById('submit-code').textContent = 'Submit Code';
                if (data.details) {
                    // Display detailed results if needed
                    const resultDiv = document.getElementById('submission-result');
                    resultDiv.innerHTML = `<pre>${JSON.stringify(data.details, null, 2)}</pre>`;
                }
            } else if (data.type === 'opponent_submission') {
                // Handle opponent submission
                addNotification(`${data.username} submitted: ${data.result}`);
            } else if (data.type === 'next_challenge') {
                addNotification('Next challenge loaded!');
                // Reload page or update challenge display
                location.reload();
            } else if (data.type === 'battle_ended') {
                addNotification('Battle ended! Redirecting to results...');
                setTimeout(() => {
                    window.location.href = `/codebattle/results/?battle_code=${battleCode}`;
                }, 2000);
            } else if (data.type === 'error') {
                addNotification(data.message, 'error');
            } else if (data.type === 'code_result') {
                // Handle run code results
                const terminalOutput = document.getElementById('terminal-output');
                if (terminalOutput) {
                    if (data.result.error) {
                        terminalOutput.innerHTML = `<div class="text-danger">${data.result.error}</div>`;
                    } else {
                        terminalOutput.innerHTML = `<div class="text-success"><pre>${data.result.output || 'No output'}</pre></div>`;
                    }
                }
            } else if (data.type === 'opponent_running_code') {
                // Handle opponent running code
                addNotification(`${data.username} is running their code...`);
            } else if (data.type === 'question_winner') {
                // Handle question winner announcement
                showQuestionWinnerPopup(data.username, data.challenge_index, data.scores);
            } else if (data.type === 'tab_warning') {
                // Handle tab switching warning
                addNotification(`‚ö†Ô∏è ${data.username} switched tabs! Battle ending...`, 'error');
                // End the battle after a short delay
                setTimeout(() => {
                    window.location.href = `/codebattle/results/?battle_code=${battleCode}`;
                }, 3000);
            }
        };

        socket.onclose = function (e) {
            console.log('WebSocket closed in editor');
            setTimeout(connectWebSocket, 1000);
        };

        socket.onerror = function (e) {
            console.log('WebSocket error in editor');
        };
    }

    function addNotification(message, type = 'info') {
        const notifications = document.getElementById('notifications');
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-info';
        const div = document.createElement('div');
        div.className = `alert ${alertClass} alert-dismissible fade show`;
        div.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notifications.appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }

    function showQuestionWinnerPopup(username, challengeIndex, scores) {
        // Create modal for question winner
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'questionWinnerModal';
        modal.setAttribute('tabindex', '-1');
        modal.setAttribute('data-bs-backdrop', 'static');
        modal.setAttribute('data-bs-keyboard', 'false');
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Question ${challengeIndex + 1} Winner!</h5>
                    </div>
                    <div class="modal-body text-center">
                        <h3 class="text-success mb-3">üéâ ${username} solved Question ${challengeIndex + 1}! üéâ</h3>
                        <div class="row justify-content-center mb-3">
                            <div class="col-8">
                                <h5>Current Scores:</h5>
                                ${Object.entries(scores).map(([player, score]) => `
                                    <p class="${player === username ? 'text-success fw-bold' : ''}">
                                        ${player}: ${score} points
                                        ${player === username ? '‚≠ê' : ''}
                                    </p>
                                `).join('')}
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <p class="mb-1">Loading next question in <strong id="countdown-timer">5</strong> seconds...</p>
                            <div class="progress" style="height: 8px;">
                                <div id="countdown-progress" class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                            Load Next Question Now
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Countdown timer
        let countdown = 5;
        const countdownEl = document.getElementById('countdown-timer');
        const progressEl = document.getElementById('countdown-progress');

        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdownEl) {
                countdownEl.textContent = countdown;
            }
            if (progressEl) {
                progressEl.style.width = (countdown / 5 * 100) + '%';
            }

            if (countdown <= 0) {
                clearInterval(countdownInterval);
            }
        }, 1000);

        // Remove modal from DOM after it's hidden
        modal.addEventListener('hidden.bs.modal', function () {
            clearInterval(countdownInterval);
            modal.remove();
        });
    }

    function updateOpponentStatus(battle) {
        const statusEl = document.getElementById('opponent-status');
        if (statusEl) {
            let status = 'Opponent Status: ';
            if (isHost && battle.player2) {
                status += battle.player2.username + ' - ' + (battle.player2_ready ? 'Ready' : 'Not Ready');
            } else if (!isHost && battle.player1) {
                status += battle.player1.username + ' - ' + (battle.player1_ready ? 'Ready' : 'Not Ready');
            }
            statusEl.textContent = status;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        connectWebSocket();

        const runBtn = document.getElementById('run-code');
        if (runBtn) {
            runBtn.addEventListener('click', function () {
                const code = document.getElementById('code-input').value;
                const language = document.getElementById('language-select').value;
                const stdin = document.getElementById('stdin-input').value;
                if (!code) {
                    addNotification('Please write some code first.', 'error');
                    return;
                }

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'run_code',
                        code: code,
                        language: language,
                        stdin: stdin
                    }));
                    addNotification('Running code...');
                    document.getElementById('terminal-output').innerHTML = '<div class="text-info">Running...</div>';
                } else {
                    addNotification('WebSocket not connected. Please refresh the page.', 'error');
                }
            });
        }

        const submitBtn = document.getElementById('submit-code');
        if (submitBtn) {
            submitBtn.addEventListener('click', function () {
                const code = document.getElementById('code-input').value;
                const language = document.getElementById('language-select').value;
                if (!code) {
                    addNotification('Please write some code first.', 'error');
                    return;
                }

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'submit_code',
                        code: code,
                        language: language
                    }));
                    addNotification('Code submitted for judging...');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Judging...';
                } else {
                    addNotification('WebSocket not connected. Please refresh the page.', 'error');
                }
            });
        }

        // Initialize opponent status
        {% if battle_data %}
        var battleData = JSON.parse('{{ battle_data|escapejs }}');
        updateOpponentStatus(battleData);
        {% endif %}
    });
</script>
{% endblock %}
